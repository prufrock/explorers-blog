<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="description" content="Notes about what I discover while programming">

        <meta property="og:title" content="Sprite Sheets in Metal Shader | David&#039;s Explorer Blog"/>
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://dkanen.com/blog/2022-08-03-sprite-sheets-in-metal-shader"/>
        <meta property="og:description" content="Notes about what I discover while programming" />

        <title>Sprite Sheets in Metal Shader | David&#039;s Explorer Blog</title>

        <link rel="home" href="https://dkanen.com/">
        <link rel="icon" href="/favicon.ico">
        <link href="/blog/feed.atom" type="application/atom+xml" rel="alternate" title="David&#039;s Explorer Blog Atom Feed">

            <meta property="og:title" content="Sprite Sheets in Metal Shader" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://dkanen.com/blog/2022-08-03-sprite-sheets-in-metal-shader"/>
    <meta property="og:description" content="All the cubes you could ask for." />

                    <!-- Matomo -->
                <script type="text/javascript">
                    var _paq = window._paq || [];
                    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
                    _paq.push(['trackPageView']);
                    _paq.push(['enableLinkTracking']);
                    (function() {
                        var u="https://matomo.dev.bushelops.com/";
                        _paq.push(['setTrackerUrl', u+'matomo.php']);
                        _paq.push(['setSiteId', '4']);
                        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
                        g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
                    })();
                </script>
                <!-- End Matomo Code -->
        
        <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:300,300i,400,400i,700,700i,800,800i" rel="stylesheet">
        <link rel="stylesheet" href="/assets/build/css/main.css?id=5caa0c2f7bf9e21596b3">
    </head>

    <body class="flex flex-col justify-between min-h-screen bg-gray-100 text-gray-800 leading-normal font-sans">
        <header class="flex items-center shadow bg-white border-b h-24 py-4" role="banner">
            <div class="container flex items-center max-w-8xl mx-auto px-4 lg:px-8">
                <div class="flex items-center">
                    <a href="/" title="David&#039;s Explorer Blog home" class="inline-flex items-center">
                        <img class="h-8 md:h-10 mr-3" src="/assets/img/logo.svg" alt="David&#039;s Explorer Blog logo" />

                        <h1 class="text-lg md:text-2xl text-blue-800 font-semibold hover:text-blue-600 my-0">David&#039;s Explorer Blog</h1>
                    </a>
                </div>

                <div id="vue-search" class="flex flex-1 justify-end items-center">
                    <search></search>

                    <nav class="hidden lg:flex items-center justify-end text-lg">
    <a title="David&#039;s Explorer Blog Blog" href="/blog"
        class="ml-6 text-gray-700 hover:text-blue-600 ">
        Blog
    </a>

    <a title="David&#039;s Explorer Blog About" href="/about"
        class="ml-6 text-gray-700 hover:text-blue-600 ">
        About
    </a>

    <a title="David&#039;s Explorer Blog Contact" href="/contact"
        class="ml-6 text-gray-700 hover:text-blue-600 ">
        Contact
    </a>
</nav>

                    <button class="flex justify-center items-center bg-blue-500 border border-blue-500 h-10 px-5 rounded-full lg:hidden focus:outline-none"
    onclick="navMenu.toggle()"
>
    <svg id="js-nav-menu-show" xmlns="http://www.w3.org/2000/svg"
        class="fill-current text-white h-9 w-4" viewBox="0 0 32 32"
    >
        <path d="M4,10h24c1.104,0,2-0.896,2-2s-0.896-2-2-2H4C2.896,6,2,6.896,2,8S2.896,10,4,10z M28,14H4c-1.104,0-2,0.896-2,2  s0.896,2,2,2h24c1.104,0,2-0.896,2-2S29.104,14,28,14z M28,22H4c-1.104,0-2,0.896-2,2s0.896,2,2,2h24c1.104,0,2-0.896,2-2  S29.104,22,28,22z"/>
    </svg>

    <svg id="js-nav-menu-hide" xmlns="http://www.w3.org/2000/svg"
        class="hidden fill-current text-white h-9 w-4" viewBox="0 0 36 30"
    >
        <polygon points="32.8,4.4 28.6,0.2 18,10.8 7.4,0.2 3.2,4.4 13.8,15 3.2,25.6 7.4,29.8 18,19.2 28.6,29.8 32.8,25.6 22.2,15 "/>
    </svg>
</button>

                </div>
            </div>
        </header>

        <nav id="js-nav-menu" class="nav-menu hidden lg:hidden">
    <ul class="my-0">
        <li class="pl-4">
            <a
                title="David&#039;s Explorer Blog Blog"
                href="/blog"
                class="nav-menu__item hover:text-blue-500 "
            >Blog</a>
        </li>
        <li class="pl-4">
            <a
                title="David&#039;s Explorer Blog About"
                href="/about"
                class="nav-menu__item hover:text-blue-500 "
            >About</a>
        </li>
        <li class="pl-4">
            <a
                title="David&#039;s Explorer Blog Contact"
                href="/contact"
                class="nav-menu__item hover:text-blue-500 "
            >Contact</a>
        </li>
    </ul>
</nav>

        <main role="main" class="flex-auto w-full container max-w-4xl mx-auto py-16 px-6">
                        <img src="https://res.cloudinary.com/demmholkv/image/upload/v1659576217/blog/shader-sprite-sheet_p9okql.png" alt="Sprite Sheets in Metal Shader cover image" class="mb-2">
    
    <h1 class="leading-none mb-2">Sprite Sheets in Metal Shader</h1>

    <p class="text-gray-700 text-xl md:mt-0">David Kanenwisher  â€¢  August 3, 2022</p>

                        <a
                href="/blog/categories/swift"
                title="View posts in swift"
                class="inline-block bg-gray-300 hover:bg-blue-200 leading-loose tracking-wide text-gray-800 uppercase text-xs font-semibold rounded mr-4 px-3 pt-px"
            >swift</a>
            
    <div class="border-b border-blue-200 mb-10 pb-4" v-pre>
        <p>I got it working to render the textures for the weapons from a sprite sheet rather than from a separate texture for each animation frame. This is pretty exciting since before I used a shader that looked like this:</p>

<pre><code>fragment float4 fragment_with_texture(VertexOut in [[stage_in]],
                              texture2d&lt;half&gt; texture0 [[ texture(0) ]],
                              texture2d&lt;half&gt; texture1 [[ texture(1) ]],
                              texture2d&lt;half&gt; texture2 [[ texture(2) ]],
                              texture2d&lt;half&gt; texture3 [[ texture(3) ]],
                              texture2d&lt;half&gt; texture4 [[ texture(4) ]],
                              texture2d&lt;half&gt; texture5 [[ texture(5) ]],
                              texture2d&lt;half&gt; texture6 [[ texture(6) ]],
                              texture2d&lt;half&gt; texture7 [[ texture(7) ]],
                              texture2d&lt;half&gt; texture8 [[ texture(8) ]],
                              texture2d&lt;half&gt; texture9 [[ texture(9) ]],
                              texture2d&lt;half&gt; texture10 [[ texture(10) ]],
                              texture2d&lt;half&gt; texture11 [[ texture(11) ]],
                              texture2d&lt;half&gt; texture12 [[ texture(12) ]],
                              texture2d&lt;half&gt; texture13 [[ texture(13) ]],
                              texture2d&lt;half&gt; texture14 [[ texture(14) ]],
                              texture2d&lt;half&gt; texture15 [[ texture(15) ]],
                              texture2d&lt;half&gt; texture16 [[ texture(16) ]],
                              texture2d&lt;half&gt; texture17 [[ texture(17) ]],
                              texture2d&lt;half&gt; texture18 [[ texture(18) ]],
                              texture2d&lt;half&gt; texture19 [[ texture(19) ]],
                              texture2d&lt;half&gt; texture20 [[ texture(20) ]],
                              constant float4 &amp;color [[buffer(0)]]
                                      ) {
</code></pre>

<p>I had to pass in so many separate textures to get this to work. I had a rough idea of how to get a sprite sheet to work after doing the work to get to render text from a sprite sheet for the RetroRampage tutorial.</p>

<p>I took that idea and applied it to applying textures to weapons. This translated easily enough because weapons, like pretty much everything else in the game, are being rendered to square billboards. I ended up with a fragment shader that looks like this:</p>

<pre><code>fragment float4 fragment_sprite_sheet(
                                      VertexOutOnlyPositionAndUv in [[stage_in]],
                                      texture2d&lt;half&gt; texture [[ texture(0) ]],
                                      constant float4 &amp;color [[buffer(0)]]
                                      ) {
</code></pre>

<p>It only takes one texture now since it's the sprite sheet. I had hoped most of the work for the spite sheet could happen in the fragment shader. It didn't work out since the fragment shader gets interpolated values so it can determine the color of each pixel. I honestly don't quite understand the magic here. Instead, the vertex shader ends up having to do most of the heavy lifting.</p>

<p>The vertex shader now needs to know the dimensions of the sprite sheet and the sprite to display. Now that information gets passed into the fragment shader as <code>uint</code> via <code>textureId</code> and a shared struct <code>SpriteSheet</code>. The <code>SpriteSheet</code> struct knows the height width of texture and of the sprites in the texture. This it possible to determine what texture to use with the single value <code>textureId</code>.</p>

<pre><code>    float txX = in.texcoord.x;
    float txY = in.texcoord.y;
    int spritesPerRow = int(spriteSheet.textureWidth / spriteSheet.spriteWidth);
    int spriteX = textureId % spritesPerRow;
    int spriteY = textureId / spritesPerRow;
    float txOffsetX = spriteSheet.spriteWidth / spriteSheet.textureWidth;
    float txOffsetY = spriteSheet.spriteHeight / spriteSheet.textureHeight;
    if (txX == 1.0) {
        txX = txOffsetX + txOffsetX * spriteX;
    } else if (txX == 0.0) {
        txX = txOffsetX * spriteX;
    }
    if (txY == 1.0) {
        txY = txOffsetY + txOffsetY * spriteY;
    } else if (txY == 0.0) {
        txY = txOffsetY * spriteY;
    }

    VertexOutOnlyPositionAndUv vertex_out {
        .position = finalTransform * float4(in.position, 1),
        .uv = float2(txX, txY)
    };
</code></pre>

<p>Now the uv coordinates for each vertex are adjusted to show only the part of the sprite sheet needed for the current animation frame.</p>

<p><img src="https://res.cloudinary.com/demmholkv/image/upload/v1659666221/blog/sprite-sheet-wand_mmoxma.gif" alt="Image of a lo-res game with a magic wand showing" title="Wand rendered in game with a sprite sheet" /></p>
    </div>

    <nav class="flex justify-between text-sm md:text-base">
        <div>
                            <a href="https://dkanen.com/blog/2021-10-16-rendering-a-bunch-of-cubes" title="Older Post: Rendering a Bunch of Cubes">
                    &LeftArrow; Rendering a Bunch of Cubes
                </a>
                    </div>

        <div>
                    </div>
    </nav>
        </main>

        <footer class="bg-white text-center text-sm mt-12 py-4" role="contentinfo">
            <ul class="flex flex-col md:flex-row justify-center list-none">
                <li class="md:mr-2">
                    &copy; David Kanenwisher 2022.
                </li>

                <li>
                    Built with <a href="http://jigsaw.tighten.co" title="Jigsaw by Tighten">Jigsaw</a>
                    and <a href="https://tailwindcss.com" title="Tailwind CSS, a utility-first CSS framework">Tailwind CSS</a>.
                </li>
            </ul>
        </footer>

        <script src="/assets/build/js/main.js?id=e9d303e5fa2156a5d2f9"></script>

        <script>
    const navMenu = {
        toggle() {
            const menu = document.getElementById('js-nav-menu');
            menu.classList.toggle('hidden');
            menu.classList.toggle('lg:block');
            document.getElementById('js-nav-menu-hide').classList.toggle('hidden');
            document.getElementById('js-nav-menu-show').classList.toggle('hidden');
        },
    }
</script>
    </body>
</html>
